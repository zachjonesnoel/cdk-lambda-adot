"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.OtelAdotStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const apigatewayv2 = require("aws-cdk-lib/aws-apigatewayv2");
const apigatewayv2_integrations = require("aws-cdk-lib/aws-apigatewayv2-integrations");
const path = require("path");
class OtelAdotStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // Get context variables with defaults
        const environment = this.node.tryGetContext('environment') || 'development';
        const serviceName = this.node.tryGetContext('serviceName') || 'Node-Lambda-ADOT';
        const adotLayerArn = this.node.tryGetContext('adotLayerVersion') || 'arn:aws:lambda:us-east-1:901920570463:layer:AWSLambda-ADOT-Lambda-NodeJS18X:1';
        const nrLicenseKey = this.node.tryGetContext('nrLicenseKey') || 'MISSING_LICENSE_KEY';
        let ADOTLayer = lambda.LayerVersion.fromLayerVersionArn(this, 'AODTLayer', adotLayerArn);
        // Create a simple Lambda function with API Gateway integration that returns a greeting message
        const greetingLambda = new lambda.Function(this, 'GreetingLambda', {
            runtime: lambda.Runtime.NODEJS_22_X,
            code: lambda.Code.fromAsset(path.join(__dirname, '../src/greeting-lambda')),
            handler: 'greeting.handler',
            architecture: lambda.Architecture.X86_64,
            environment: {
                ENVIRONMENT: environment,
                SERVICE_NAME: serviceName,
                AWS_LAMBDA_EXEC_WRAPPER: '/opt/otel-handler',
                OTEL_EXPORTER_OTLP_ENDPOINT: 'https://otlp.nr-data.net:4317',
                OTEL_EXPORTER_OTLP_HEADERS: 'api-key=' + nrLicenseKey,
                OTEL_SERVICE_NAME: serviceName,
            },
            description: `Greeting Lambda function for ${serviceName} in ${environment} environment`,
            tracing: lambda.Tracing.ACTIVE,
            memorySize: 128,
            timeout: cdk.Duration.seconds(5),
            layers: [ADOTLayer],
        });
        const greetinglambdaIntegration = new apigatewayv2_integrations.HttpLambdaIntegration('GreetingIntegration', greetingLambda);
        // Create an API Gateway HTTP API
        const greetingApi = new apigatewayv2.HttpApi(this, 'GreetingApi', {
            apiName: `${serviceName}-GreetingAPI-${environment}`,
            description: `Greeting API Gateway for ${serviceName} in ${environment} environment`,
            defaultIntegration: greetinglambdaIntegration,
        });
        // Add a root path to the API
        greetingApi.addRoutes({
            path: '/',
            methods: [apigatewayv2.HttpMethod.GET],
            integration: greetinglambdaIntegration
        });
        // Output the API URL
        new cdk.CfnOutput(this, 'GreetingApiUrl', {
            value: greetingApi.apiEndpoint,
            description: 'Greeting API Gateway endpoint URL',
            exportName: `${id}-GreetingApiEndpoint`
        });
        // Output the environment
        new cdk.CfnOutput(this, 'GreetingEnvironment', {
            value: environment,
            description: 'Greeting Lambda deployment environment',
            exportName: `${id}-GreetingEnvironment`
        });
        // Output the service name
        new cdk.CfnOutput(this, 'GreetingServiceName', {
            value: serviceName,
            description: 'Greeting Lambda service name used for telemetry',
            exportName: `${id}-GreetingServiceName`
        });
        const HelloLambdaFunction = new lambda.Function(this, 'HelloLambdaFunction', {
            runtime: lambda.Runtime.NODEJS_22_X,
            code: lambda.Code.fromAsset(path.join(__dirname, '../src/invoker-lambda')),
            handler: 'index.handler',
            architecture: lambda.Architecture.X86_64,
            environment: {
                ENVIRONMENT: environment,
                SERVICE_NAME: serviceName,
                AWS_LAMBDA_EXEC_WRAPPER: '/opt/otel-handler',
                OTEL_EXPORTER_OTLP_ENDPOINT: 'https://otlp.nr-data.net:4317',
                OTEL_EXPORTER_OTLP_HEADERS: 'api-key=' + nrLicenseKey,
                OTEL_SERVICE_NAME: serviceName,
            },
            description: `Lambda function for ${serviceName} in ${environment} environment`,
            tracing: lambda.Tracing.ACTIVE,
            layers: [ADOTLayer],
        });
        // Create HTTP API Gateway
        const lambdaIntegration = new apigatewayv2_integrations.HttpLambdaIntegration('OtelAdotIntegration', HelloLambdaFunction);
        const httpApi = new apigatewayv2.HttpApi(this, 'OtelAdotHttpApi', {
            apiName: `${serviceName}-API-${environment}`,
            description: `HTTP API Gateway for ${serviceName} in ${environment} environment`,
            defaultIntegration: lambdaIntegration,
        });
        // Add root path
        httpApi.addRoutes({
            path: '/',
            methods: [apigatewayv2.HttpMethod.GET],
            integration: lambdaIntegration
        });
        // Output the API URL
        new cdk.CfnOutput(this, 'ApiUrl', {
            value: httpApi.apiEndpoint,
            description: 'HTTP API Gateway endpoint URL',
            exportName: `${id}-ApiEndpoint`
        });
        // Output the environment
        new cdk.CfnOutput(this, 'Environment', {
            value: environment,
            description: 'Deployment environment',
            exportName: `${id}-Environment`
        });
        // Output the service name
        new cdk.CfnOutput(this, 'ServiceName', {
            value: serviceName,
            description: 'Service name used for telemetry',
            exportName: `${id}-ServiceName`
        });
        // Add tags to the Lambda function
        cdk.Tags.of(HelloLambdaFunction).add('Environment', environment);
        cdk.Tags.of(HelloLambdaFunction).add('ServiceName', serviceName);
        cdk.Tags.of(HelloLambdaFunction).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(HelloLambdaFunction).add('ManagedBy', 'CDK');
        cdk.Tags.of(HelloLambdaFunction).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the API Gateway
        cdk.Tags.of(httpApi).add('Environment', environment);
        cdk.Tags.of(httpApi).add('ServiceName', serviceName);
        cdk.Tags.of(httpApi).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(httpApi).add('ManagedBy', 'CDK');
        cdk.Tags.of(httpApi).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the greeting Lambda function
        cdk.Tags.of(greetingLambda).add('Environment', environment);
        cdk.Tags.of(greetingLambda).add('ServiceName', serviceName);
        cdk.Tags.of(greetingLambda).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(greetingLambda).add('ManagedBy', 'CDK');
        cdk.Tags.of(greetingLambda).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the greeting API Gateway
        cdk.Tags.of(greetingApi).add('Environment', environment);
        cdk.Tags.of(greetingApi).add('ServiceName', serviceName);
        cdk.Tags.of(greetingApi).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(greetingApi).add('ManagedBy', 'CDK');
        cdk.Tags.of(greetingApi).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the stack
        cdk.Tags.of(this).add('Environment', environment);
        cdk.Tags.of(this).add('ServiceName', serviceName);
        cdk.Tags.of(this).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(this).add('ManagedBy', 'CDK');
        cdk.Tags.of(this).add('Workshop', 'AWS CDK ADOT Workshop');
    }
}
exports.OtelAdotStack = OtelAdotStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiMi1sYW1iZGEtYWRvdC1zdGFjay5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIjItbGFtYmRhLWFkb3Qtc3RhY2sudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQW1DO0FBQ25DLGlEQUFpRDtBQUNqRCw2REFBNkQ7QUFDN0QsdUZBQXVGO0FBRXZGLDZCQUE2QjtBQUU3QixNQUFhLGFBQWMsU0FBUSxHQUFHLENBQUMsS0FBSztJQUMxQyxZQUFZLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXNCO1FBQzlELEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXhCLHNDQUFzQztRQUN0QyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxhQUFhLENBQUM7UUFDNUUsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksa0JBQWtCLENBQUM7UUFDakYsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsa0JBQWtCLENBQUMsSUFBSSwrRUFBK0UsQ0FBQztRQUNwSixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsSUFBSSxxQkFBcUIsQ0FBQztRQUV0RixJQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLG1CQUFtQixDQUNuRCxJQUFJLEVBQ0osV0FBVyxFQUNYLFlBQVksQ0FDYixDQUFBO1FBQ0gsK0ZBQStGO1FBQy9GLE1BQU0sY0FBYyxHQUFHLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLEVBQUU7WUFDakUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVztZQUNuQyxJQUFJLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxD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QUM7UUFDMUQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNqRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLHVCQUF1QixDQUFDLENBQUM7UUFDbEUsd0JBQXdCO1FBQ3hCLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDbEQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztRQUNsRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDbkQsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUMxQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLHVCQUF1QixDQUFDLENBQUM7SUFFN0QsQ0FBQztDQUNGO0FBbEtELHNDQWtLQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgKiBhcyBsYW1iZGEgZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSc7XG5pbXBvcnQgKiBhcyBhcGlnYXRld2F5djIgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXl2Mic7XG5pbXBvcnQgKiBhcyBhcGlnYXRld2F5djJfaW50ZWdyYXRpb25zIGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcGlnYXRld2F5djItaW50ZWdyYXRpb25zJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcblxuZXhwb3J0IGNsYXNzIE90ZWxBZG90U3RhY2sgZXh0ZW5kcyBjZGsuU3RhY2sge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgXG4gICAgLy8gR2V0IGNvbnRleHQgdmFyaWFibGVzIHdpdGggZGVmYXVsdHNcbiAgICBjb25zdCBlbnZpcm9ubWVudCA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdlbnZpcm9ubWVudCcpIHx8ICdkZXZlbG9wbWVudCc7XG4gICAgY29uc3Qgc2VydmljZU5hbWUgPSB0aGlzLm5vZGUudHJ5R2V0Q29udGV4dCgnc2VydmljZU5hbWUnKSB8fCAnTm9kZS1MYW1iZGEtQURPVCc7XG4gICAgY29uc3QgYWRvdExheWVyQXJuID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ2Fkb3RMYXllclZlcnNpb24nKSB8fCAnYXJuOmF3czpsYW1iZGE6dXMtZWFzdC0xOjkwMTkyMDU3MDQ2MzpsYXllcjpBV1NMYW1iZGEtQURPVC1MYW1iZGEtTm9kZUpTMThYOjEnO1xuICAgIGNvbnN0IG5yTGljZW5zZUtleSA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCduckxpY2Vuc2VLZXknKSB8fCAnTUlTU0lOR19MSUNFTlNFX0tFWSc7XG5cbiAgICBsZXQgQURPVExheWVyID0gbGFtYmRhLkxheWVyVmVyc2lvbi5mcm9tTGF5ZXJWZXJzaW9uQXJuKFxuICAgICAgICB0aGlzLFxuICAgICAgICAnQU9EVExheWVyJyxcbiAgICAgICAgYWRvdExheWVyQXJuXG4gICAgICApXG4gICAgLy8gQ3JlYXRlIGEgc2ltcGxlIExhbWJkYSBmdW5jdGlvbiB3aXRoIEFQSSBHYXRld2F5IGludGVncmF0aW9uIHRoYXQgcmV0dXJucyBhIGdyZWV0aW5nIG1lc3NhZ2VcbiAgICBjb25zdCBncmVldGluZ0xhbWJkYSA9IG5ldyBsYW1iZGEuRnVuY3Rpb24odGhpcywgJ0dyZWV0aW5nTGFtYmRhJywge1xuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIyX1gsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3NyYy9ncmVldGluZy1sYW1iZGEnKSksXG4gICAgICBoYW5kbGVyOiAnZ3JlZXRpbmcuaGFuZGxlcicsXG4gICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuWDg2XzY0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRU5WSVJPTk1FTlQ6IGVudmlyb25tZW50LFxuICAgICAgICBTRVJWSUNFX05BTUU6IHNlcnZpY2VOYW1lLFxuICAgICAgICBBV1NfTEFNQkRBX0VYRUNfV1JBUFBFUjogJy9vcHQvb3RlbC1oYW5kbGVyJyxcbiAgICAgICAgT1RFTF9FWFBPUlRFUl9PVExQX0VORFBPSU5UOiAnaHR0cHM6Ly9vdGxwLm5yLWRhdGEubmV0OjQzMTcnLFxuICAgICAgICBPVEVMX0VYUE9SVEVSX09UTFBfSEVBREVSUzogJ2FwaS1rZXk9JyArIG5yTGljZW5zZUtleSxcbiAgICAgICAgT1RFTF9TRVJWSUNFX05BTUU6IHNlcnZpY2VOYW1lLFxuICAgICAgfSxcbiAgICAgIGRlc2NyaXB0aW9uOiBgR3JlZXRpbmcgTGFtYmRhIGZ1bmN0aW9uIGZvciAke3NlcnZpY2VOYW1lfSBpbiAke2Vudmlyb25tZW50fSBlbnZpcm9ubWVudGAsXG4gICAgICB0cmFjaW5nOiBsYW1iZGEuVHJhY2luZy5BQ1RJVkUsXG4gICAgICBtZW1vcnlTaXplOiAxMjgsXG4gICAgICB0aW1lb3V0OiBjZGsuRHVyYXRpb24uc2Vjb25kcyg1KSxcbiAgICAgIGxheWVyczogW0FET1RMYXllcl0sXG4gICAgfSk7XG5cbiAgICBjb25zdCBncmVldGluZ2xhbWJkYUludGVncmF0aW9uID0gbmV3IGFwaWdhdGV3YXl2Ml9pbnRlZ3JhdGlvbnMuSHR0cExhbWJkYUludGVncmF0aW9uKCdHcmVldGluZ0ludGVncmF0aW9uJywgZ3JlZXRpbmdMYW1iZGEpXG5cbiAgICAvLyBDcmVhdGUgYW4gQVBJIEdhdGV3YXkgSFRUUCBBUElcbiAgICBjb25zdCBncmVldGluZ0FwaSA9IG5ldyBhcGlnYXRld2F5djIuSHR0cEFwaSh0aGlzLCAnR3JlZXRpbmdBcGknLCB7XG4gICAgICBhcGlOYW1lOiBgJHtzZXJ2aWNlTmFtZX0tR3JlZXRpbmdBUEktJHtlbnZpcm9ubWVudH1gLFxuICAgICAgZGVzY3JpcHRpb246IGBHcmVldGluZyBBUEkgR2F0ZXdheSBmb3IgJHtzZXJ2aWNlTmFtZX0gaW4gJHtlbnZpcm9ubWVudH0gZW52aXJvbm1lbnRgLFxuICAgICAgZGVmYXVsdEludGVncmF0aW9uOiBncmVldGluZ2xhbWJkYUludGVncmF0aW9uLFxuICAgIH0pO1xuXG4gICAgLy8gQWRkIGEgcm9vdCBwYXRoIHRvIHRoZSBBUElcbiAgICBncmVldGluZ0FwaS5hZGRSb3V0ZXMoe1xuICAgICAgcGF0aDogJy8nLFxuICAgICAgbWV0aG9kczogW2FwaWdhdGV3YXl2Mi5IdHRwTWV0aG9kLkdFVF0sXG4gICAgICBpbnRlZ3JhdGlvbjogZ3JlZXRpbmdsYW1iZGFJbnRlZ3JhdGlvblxuICAgIH0pO1xuXG4gICAgLy8gT3V0cHV0IHRoZSBBUEkgVVJMXG4gICAgbmV3IGNkay5DZm5PdXRwdXQodGhpcywgJ0dyZWV0aW5nQXBpVXJsJywge1xuICAgICAgdmFsdWU6IGdyZWV0aW5nQXBpLmFwaUVuZHBvaW50LFxuICAgICAgZGVzY3JpcHRpb246ICdHcmVldGluZyBBUEkgR2F0ZXdheSBlbmRwb2ludCBVUkwnLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LUdyZWV0aW5nQXBpRW5kcG9pbnRgXG4gICAgfSk7XG4gICAgLy8gT3V0cHV0IHRoZSBlbnZpcm9ubWVudFxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdHcmVldGluZ0Vudmlyb25tZW50Jywge1xuICAgICAgdmFsdWU6IGVudmlyb25tZW50LFxuICAgICAgZGVzY3JpcHRpb246ICdHcmVldGluZyBMYW1iZGEgZGVwbG95bWVudCBlbnZpcm9ubWVudCcsXG4gICAgICBleHBvcnROYW1lOiBgJHtpZH0tR3JlZXRpbmdFbnZpcm9ubWVudGBcbiAgICB9KTtcbiAgICAvLyBPdXRwdXQgdGhlIHNlcnZpY2UgbmFtZVxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdHcmVldGluZ1NlcnZpY2VOYW1lJywge1xuICAgICAgdmFsdWU6IHNlcnZpY2VOYW1lLFxuICAgICAgZGVzY3JpcHRpb246ICdHcmVldGluZyBMYW1iZGEgc2VydmljZSBuYW1lIHVzZWQgZm9yIHRlbGVtZXRyeScsXG4gICAgICBleHBvcnROYW1lOiBgJHtpZH0tR3JlZXRpbmdTZXJ2aWNlTmFtZWBcbiAgICB9KTtcblxuICAgIGNvbnN0IEhlbGxvTGFtYmRhRnVuY3Rpb24gPSBuZXcgbGFtYmRhLkZ1bmN0aW9uKHRoaXMsICdIZWxsb0xhbWJkYUZ1bmN0aW9uJywge1xuICAgICAgcnVudGltZTogbGFtYmRhLlJ1bnRpbWUuTk9ERUpTXzIyX1gsXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3NyYy9pbnZva2VyLWxhbWJkYScpKSxcbiAgICAgIGhhbmRsZXI6ICdpbmRleC5oYW5kbGVyJyxcbiAgICAgIGFyY2hpdGVjdHVyZTogbGFtYmRhLkFyY2hpdGVjdHVyZS5YODZfNjQsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBFTlZJUk9OTUVOVDogZW52aXJvbm1lbnQsXG4gICAgICAgIFNFUlZJQ0VfTkFNRTogc2VydmljZU5hbWUsXG4gICAgICAgIEFXU19MQU1CREFfRVhFQ19XUkFQUEVSOiAnL29wdC9vdGVsLWhhbmRsZXInLFxuICAgICAgICBPVEVMX0VYUE9SVEVSX09UTFBfRU5EUE9JTlQ6ICdodHRwczovL290bHAubnItZGF0YS5uZXQ6NDMxNycsXG4gICAgICAgIE9URUxfRVhQT1JURVJfT1RMUF9IRUFERVJTOiAnYXBpLWtleT0nICsgbnJMaWNlbnNlS2V5LFxuICAgICAgICBPVEVMX1NFUlZJQ0VfTkFNRTogc2VydmljZU5hbWUsXG4gICAgICB9LFxuICAgICAgZGVzY3JpcHRpb246IGBMYW1iZGEgZnVuY3Rpb24gZm9yICR7c2VydmljZU5hbWV9IGluICR7ZW52aXJvbm1lbnR9IGVudmlyb25tZW50YCxcbiAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgIGxheWVyczogW0FET1RMYXllcl0sXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgSFRUUCBBUEkgR2F0ZXdheVxuICAgIGNvbnN0IGxhbWJkYUludGVncmF0aW9uID0gbmV3IGFwaWdhdGV3YXl2Ml9pbnRlZ3JhdGlvbnMuSHR0cExhbWJkYUludGVncmF0aW9uKFxuICAgICAgJ090ZWxBZG90SW50ZWdyYXRpb24nLCBcbiAgICAgIEhlbGxvTGFtYmRhRnVuY3Rpb25cbiAgICApO1xuXG4gICAgY29uc3QgaHR0cEFwaSA9IG5ldyBhcGlnYXRld2F5djIuSHR0cEFwaSh0aGlzLCAnT3RlbEFkb3RIdHRwQXBpJywge1xuICAgICAgYXBpTmFtZTogYCR7c2VydmljZU5hbWV9LUFQSS0ke2Vudmlyb25tZW50fWAsXG4gICAgICBkZXNjcmlwdGlvbjogYEhUVFAgQVBJIEdhdGV3YXkgZm9yICR7c2VydmljZU5hbWV9IGluICR7ZW52aXJvbm1lbnR9IGVudmlyb25tZW50YCxcbiAgICAgIGRlZmF1bHRJbnRlZ3JhdGlvbjogbGFtYmRhSW50ZWdyYXRpb24sXG4gICAgfSk7XG5cbiAgICAvLyBBZGQgcm9vdCBwYXRoXG4gICAgaHR0cEFwaS5hZGRSb3V0ZXMoe1xuICAgICAgcGF0aDogJy8nLFxuICAgICAgbWV0aG9kczogW2FwaWdhdGV3YXl2Mi5IdHRwTWV0aG9kLkdFVF0sXG4gICAgICBpbnRlZ3JhdGlvbjogbGFtYmRhSW50ZWdyYXRpb25cbiAgICB9KTtcbiAgICBcbiAgICAvLyBPdXRwdXQgdGhlIEFQSSBVUkxcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnQXBpVXJsJywge1xuICAgICAgdmFsdWU6IGh0dHBBcGkuYXBpRW5kcG9pbnQsXG4gICAgICBkZXNjcmlwdGlvbjogJ0hUVFAgQVBJIEdhdGV3YXkgZW5kcG9pbnQgVVJMJyxcbiAgICAgIGV4cG9ydE5hbWU6IGAke2lkfS1BcGlFbmRwb2ludGBcbiAgICB9KTtcblxuICAgIC8vIE91dHB1dCB0aGUgZW52aXJvbm1lbnRcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnRW52aXJvbm1lbnQnLCB7XG4gICAgICB2YWx1ZTogZW52aXJvbm1lbnQsXG4gICAgICBkZXNjcmlwdGlvbjogJ0RlcGxveW1lbnQgZW52aXJvbm1lbnQnLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LUVudmlyb25tZW50YFxuICAgIH0pO1xuXG4gICAgLy8gT3V0cHV0IHRoZSBzZXJ2aWNlIG5hbWVcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnU2VydmljZU5hbWUnLCB7XG4gICAgICB2YWx1ZTogc2VydmljZU5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NlcnZpY2UgbmFtZSB1c2VkIGZvciB0ZWxlbWV0cnknLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LVNlcnZpY2VOYW1lYFxuICAgIH0pO1xuXG4gICAgXG4gICAgLy8gQWRkIHRhZ3MgdG8gdGhlIExhbWJkYSBmdW5jdGlvblxuICAgIGNkay5UYWdzLm9mKEhlbGxvTGFtYmRhRnVuY3Rpb24pLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG4gICAgY2RrLlRhZ3Mub2YoSGVsbG9MYW1iZGFGdW5jdGlvbikuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ01hbmFnZWRCeScsICdDREsnKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBBUEkgR2F0ZXdheVxuICAgIGNkay5UYWdzLm9mKGh0dHBBcGkpLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG4gICAgY2RrLlRhZ3Mub2YoaHR0cEFwaSkuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ01hbmFnZWRCeScsICdDREsnKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBncmVldGluZyBMYW1iZGEgZnVuY3Rpb25cbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdFbnZpcm9ubWVudCcsIGVudmlyb25tZW50KTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdQcm9qZWN0JywgJ090ZWxBZG90TGFtYmRhJyk7XG4gICAgY2RrLlRhZ3Mub2YoZ3JlZXRpbmdMYW1iZGEpLmFkZCgnTWFuYWdlZEJ5JywgJ0NESycpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nTGFtYmRhKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBncmVldGluZyBBUEkgR2F0ZXdheVxuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ0Vudmlyb25tZW50JywgZW52aXJvbm1lbnQpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ1NlcnZpY2VOYW1lJywgc2VydmljZU5hbWUpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0FwaSkuYWRkKCdNYW5hZ2VkQnknLCAnQ0RLJyk7XG4gICAgY2RrLlRhZ3Mub2YoZ3JlZXRpbmdBcGkpLmFkZCgnV29ya3Nob3AnLCAnQVdTIENESyBBRE9UIFdvcmtzaG9wJyk7XG4gICAgLy8gQWRkIHRhZ3MgdG8gdGhlIHN0YWNrXG4gICAgY2RrLlRhZ3Mub2YodGhpcykuYWRkKCdFbnZpcm9ubWVudCcsIGVudmlyb25tZW50KTtcbiAgICBjZGsuVGFncy5vZih0aGlzKS5hZGQoJ1NlcnZpY2VOYW1lJywgc2VydmljZU5hbWUpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnUHJvamVjdCcsICdPdGVsQWRvdExhbWJkYScpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnTWFuYWdlZEJ5JywgJ0NESycpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnV29ya3Nob3AnLCAnQVdTIENESyBBRE9UIFdvcmtzaG9wJyk7XG5cbiAgfVxufSJdfQ==