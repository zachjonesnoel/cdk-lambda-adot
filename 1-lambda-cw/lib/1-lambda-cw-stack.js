"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.OtelAdotStack = void 0;
const cdk = require("aws-cdk-lib");
const lambda = require("aws-cdk-lib/aws-lambda");
const apigatewayv2 = require("aws-cdk-lib/aws-apigatewayv2");
const apigatewayv2_integrations = require("aws-cdk-lib/aws-apigatewayv2-integrations");
const path = require("path");
class OtelAdotStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        // Get context variables with defaults
        const environment = this.node.tryGetContext('environment') || 'development';
        const serviceName = this.node.tryGetContext('serviceName') || 'Node-Lambda-ADOT';
        // Create a simple Lambda function with API Gateway integration that returns a greeting message
        const greetingLambda = new lambda.Function(this, 'GreetingLambda', {
            runtime: lambda.Runtime.NODEJS_18_X,
            code: lambda.Code.fromAsset(path.join(__dirname, '../src/greeting-lambda')),
            handler: 'greeting.handler',
            architecture: lambda.Architecture.X86_64,
            environment: {
                ENVIRONMENT: environment,
                SERVICE_NAME: serviceName,
            },
            description: `Greeting Lambda function for ${serviceName} in ${environment} environment`,
            tracing: lambda.Tracing.ACTIVE,
            memorySize: 128,
            timeout: cdk.Duration.seconds(5),
        });
        const greetinglambdaIntegration = new apigatewayv2_integrations.HttpLambdaIntegration('GreetingIntegration', greetingLambda);
        // Create an API Gateway HTTP API
        const greetingApi = new apigatewayv2.HttpApi(this, 'GreetingApi', {
            apiName: `${serviceName}-GreetingAPI-${environment}`,
            description: `Greeting API Gateway for ${serviceName} in ${environment} environment`,
            defaultIntegration: greetinglambdaIntegration,
        });
        // Add a root path to the API
        greetingApi.addRoutes({
            path: '/',
            methods: [apigatewayv2.HttpMethod.GET],
            integration: greetinglambdaIntegration
        });
        // Output the API URL
        new cdk.CfnOutput(this, 'GreetingApiUrl', {
            value: greetingApi.apiEndpoint,
            description: 'Greeting API Gateway endpoint URL',
            exportName: `${id}-GreetingApiEndpoint`
        });
        // Output the environment
        new cdk.CfnOutput(this, 'GreetingEnvironment', {
            value: environment,
            description: 'Greeting Lambda deployment environment',
            exportName: `${id}-GreetingEnvironment`
        });
        // Output the service name
        new cdk.CfnOutput(this, 'GreetingServiceName', {
            value: serviceName,
            description: 'Greeting Lambda service name used for telemetry',
            exportName: `${id}-GreetingServiceName`
        });
        const HelloLambdaFunction = new lambda.Function(this, 'HelloLambdaFunction', {
            runtime: lambda.Runtime.NODEJS_18_X,
            code: lambda.Code.fromAsset(path.join(__dirname, '../src/invoker-lambda')),
            handler: 'index.handler',
            architecture: lambda.Architecture.X86_64,
            environment: {
                ENVIRONMENT: environment,
                GREETING_API_ENDPOINT: greetingApi.apiEndpoint,
            },
            description: `Lambda function for ${serviceName} in ${environment} environment`,
            tracing: lambda.Tracing.ACTIVE,
        });
        // Create HTTP API Gateway
        const lambdaIntegration = new apigatewayv2_integrations.HttpLambdaIntegration('OtelAdotIntegration', HelloLambdaFunction);
        const httpApi = new apigatewayv2.HttpApi(this, 'OtelAdotHttpApi', {
            apiName: `${serviceName}-API-${environment}`,
            description: `HTTP API Gateway for ${serviceName} in ${environment} environment`,
            defaultIntegration: lambdaIntegration,
        });
        // Add root path
        httpApi.addRoutes({
            path: '/',
            methods: [apigatewayv2.HttpMethod.GET],
            integration: lambdaIntegration
        });
        // Output the API URL
        new cdk.CfnOutput(this, 'ApiUrl', {
            value: httpApi.apiEndpoint,
            description: 'HTTP API Gateway endpoint URL',
            exportName: `${id}-ApiEndpoint`
        });
        // Output the environment
        new cdk.CfnOutput(this, 'Environment', {
            value: environment,
            description: 'Deployment environment',
            exportName: `${id}-Environment`
        });
        // Output the service name
        new cdk.CfnOutput(this, 'ServiceName', {
            value: serviceName,
            description: 'Service name used for telemetry',
            exportName: `${id}-ServiceName`
        });
        // Add tags to the Lambda function
        cdk.Tags.of(HelloLambdaFunction).add('Environment', environment);
        cdk.Tags.of(HelloLambdaFunction).add('ServiceName', serviceName);
        cdk.Tags.of(HelloLambdaFunction).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(HelloLambdaFunction).add('ManagedBy', 'CDK');
        cdk.Tags.of(HelloLambdaFunction).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the API Gateway
        cdk.Tags.of(httpApi).add('Environment', environment);
        cdk.Tags.of(httpApi).add('ServiceName', serviceName);
        cdk.Tags.of(httpApi).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(httpApi).add('ManagedBy', 'CDK');
        cdk.Tags.of(httpApi).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the greeting Lambda function
        cdk.Tags.of(greetingLambda).add('Environment', environment);
        cdk.Tags.of(greetingLambda).add('ServiceName', serviceName);
        cdk.Tags.of(greetingLambda).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(greetingLambda).add('ManagedBy', 'CDK');
        cdk.Tags.of(greetingLambda).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the greeting API Gateway
        cdk.Tags.of(greetingApi).add('Environment', environment);
        cdk.Tags.of(greetingApi).add('ServiceName', serviceName);
        cdk.Tags.of(greetingApi).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(greetingApi).add('ManagedBy', 'CDK');
        cdk.Tags.of(greetingApi).add('Workshop', 'AWS CDK ADOT Workshop');
        // Add tags to the stack
        cdk.Tags.of(this).add('Environment', environment);
        cdk.Tags.of(this).add('ServiceName', serviceName);
        cdk.Tags.of(this).add('Project', 'OtelAdotLambda');
        cdk.Tags.of(this).add('ManagedBy', 'CDK');
        cdk.Tags.of(this).add('Workshop', 'AWS CDK ADOT Workshop');
    }
}
exports.OtelAdotStack = OtelAdotStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiMS1sYW1iZGEtY3ctc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIxLWxhbWJkYS1jdy1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtQ0FBbUM7QUFDbkMsaURBQWlEO0FBQ2pELDZEQUE2RDtBQUM3RCx1RkFBdUY7QUFFdkYsNkJBQTZCO0FBRTdCLE1BQWEsYUFBYyxTQUFRLEdBQUcsQ0FBQyxLQUFLO0lBQzFDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBc0I7UUFDOUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFeEIsc0NBQXNDO1FBQ3RDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxJQUFJLGFBQWEsQ0FBQztRQUM1RSxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsSUFBSSxrQkFBa0IsQ0FBQztRQUlqRiwrRkFBK0Y7UUFDL0YsTUFBTSxjQUFjLEdBQUcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxnQkFBZ0IsRUFBRTtZQUNqRSxPQUFPLEVBQUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXO1lBQ25DLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO1lBQzNFLE9BQU8sRUFBRSxrQkFBa0I7WUFDM0IsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTTtZQUN4QyxXQUFXLEVBQUU7Z0JBQ1gsV0FBVyxFQUFFLFdBQVc7Z0JBQ3hCLFlBQVksRUFBRSxXQUFXO2FBQzFCO1lBQ0QsV0FBVyxFQUFFLGdDQUFnQyxXQUFXLE9BQU8sV0FBVyxjQUFjO1lBQ3hGLE9BQU8sRUFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLE1B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LEtBQUssQ0FBQyxDQUFDO1FBQzFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQUUsdUJBQXVCLENBQUMsQ0FBQztJQUU3RCxDQUFDO0NBQ0Y7QUFuSkQsc0NBbUpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY2RrIGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIGxhbWJkYSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtbGFtYmRhJztcbmltcG9ydCAqIGFzIGFwaWdhdGV3YXl2MiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYXBpZ2F0ZXdheXYyJztcbmltcG9ydCAqIGFzIGFwaWdhdGV3YXl2Ml9pbnRlZ3JhdGlvbnMgZnJvbSAnYXdzLWNkay1saWIvYXdzLWFwaWdhdGV3YXl2Mi1pbnRlZ3JhdGlvbnMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuXG5leHBvcnQgY2xhc3MgT3RlbEFkb3RTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzPzogY2RrLlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQsIHByb3BzKTtcbiAgICBcbiAgICAvLyBHZXQgY29udGV4dCB2YXJpYWJsZXMgd2l0aCBkZWZhdWx0c1xuICAgIGNvbnN0IGVudmlyb25tZW50ID0gdGhpcy5ub2RlLnRyeUdldENvbnRleHQoJ2Vudmlyb25tZW50JykgfHwgJ2RldmVsb3BtZW50JztcbiAgICBjb25zdCBzZXJ2aWNlTmFtZSA9IHRoaXMubm9kZS50cnlHZXRDb250ZXh0KCdzZXJ2aWNlTmFtZScpIHx8ICdOb2RlLUxhbWJkYS1BRE9UJztcblxuXG5cbiAgICAvLyBDcmVhdGUgYSBzaW1wbGUgTGFtYmRhIGZ1bmN0aW9uIHdpdGggQVBJIEdhdGV3YXkgaW50ZWdyYXRpb24gdGhhdCByZXR1cm5zIGEgZ3JlZXRpbmcgbWVzc2FnZVxuICAgIGNvbnN0IGdyZWV0aW5nTGFtYmRhID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnR3JlZXRpbmdMYW1iZGEnLCB7XG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5OT0RFSlNfMThfWCxcbiAgICAgIGNvZGU6IGxhbWJkYS5Db2RlLmZyb21Bc3NldChwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vc3JjL2dyZWV0aW5nLWxhbWJkYScpKSxcbiAgICAgIGhhbmRsZXI6ICdncmVldGluZy5oYW5kbGVyJyxcbiAgICAgIGFyY2hpdGVjdHVyZTogbGFtYmRhLkFyY2hpdGVjdHVyZS5YODZfNjQsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBFTlZJUk9OTUVOVDogZW52aXJvbm1lbnQsXG4gICAgICAgIFNFUlZJQ0VfTkFNRTogc2VydmljZU5hbWUsXG4gICAgICB9LFxuICAgICAgZGVzY3JpcHRpb246IGBHcmVldGluZyBMYW1iZGEgZnVuY3Rpb24gZm9yICR7c2VydmljZU5hbWV9IGluICR7ZW52aXJvbm1lbnR9IGVudmlyb25tZW50YCxcbiAgICAgIHRyYWNpbmc6IGxhbWJkYS5UcmFjaW5nLkFDVElWRSxcbiAgICAgIG1lbW9yeVNpemU6IDEyOCxcbiAgICAgIHRpbWVvdXQ6IGNkay5EdXJhdGlvbi5zZWNvbmRzKDUpLFxuICAgIH0pO1xuXG4gICAgY29uc3QgZ3JlZXRpbmdsYW1iZGFJbnRlZ3JhdGlvbiA9IG5ldyBhcGlnYXRld2F5djJfaW50ZWdyYXRpb25zLkh0dHBMYW1iZGFJbnRlZ3JhdGlvbignR3JlZXRpbmdJbnRlZ3JhdGlvbicsIGdyZWV0aW5nTGFtYmRhKVxuXG4gICAgLy8gQ3JlYXRlIGFuIEFQSSBHYXRld2F5IEhUVFAgQVBJXG4gICAgY29uc3QgZ3JlZXRpbmdBcGkgPSBuZXcgYXBpZ2F0ZXdheXYyLkh0dHBBcGkodGhpcywgJ0dyZWV0aW5nQXBpJywge1xuICAgICAgYXBpTmFtZTogYCR7c2VydmljZU5hbWV9LUdyZWV0aW5nQVBJLSR7ZW52aXJvbm1lbnR9YCxcbiAgICAgIGRlc2NyaXB0aW9uOiBgR3JlZXRpbmcgQVBJIEdhdGV3YXkgZm9yICR7c2VydmljZU5hbWV9IGluICR7ZW52aXJvbm1lbnR9IGVudmlyb25tZW50YCxcbiAgICAgIGRlZmF1bHRJbnRlZ3JhdGlvbjogZ3JlZXRpbmdsYW1iZGFJbnRlZ3JhdGlvbixcbiAgICB9KTtcblxuICAgIC8vIEFkZCBhIHJvb3QgcGF0aCB0byB0aGUgQVBJXG4gICAgZ3JlZXRpbmdBcGkuYWRkUm91dGVzKHtcbiAgICAgIHBhdGg6ICcvJyxcbiAgICAgIG1ldGhvZHM6IFthcGlnYXRld2F5djIuSHR0cE1ldGhvZC5HRVRdLFxuICAgICAgaW50ZWdyYXRpb246IGdyZWV0aW5nbGFtYmRhSW50ZWdyYXRpb25cbiAgICB9KTtcblxuICAgIC8vIE91dHB1dCB0aGUgQVBJIFVSTFxuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdHcmVldGluZ0FwaVVybCcsIHtcbiAgICAgIHZhbHVlOiBncmVldGluZ0FwaS5hcGlFbmRwb2ludCxcbiAgICAgIGRlc2NyaXB0aW9uOiAnR3JlZXRpbmcgQVBJIEdhdGV3YXkgZW5kcG9pbnQgVVJMJyxcbiAgICAgIGV4cG9ydE5hbWU6IGAke2lkfS1HcmVldGluZ0FwaUVuZHBvaW50YFxuICAgIH0pO1xuICAgIC8vIE91dHB1dCB0aGUgZW52aXJvbm1lbnRcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnR3JlZXRpbmdFbnZpcm9ubWVudCcsIHtcbiAgICAgIHZhbHVlOiBlbnZpcm9ubWVudCxcbiAgICAgIGRlc2NyaXB0aW9uOiAnR3JlZXRpbmcgTGFtYmRhIGRlcGxveW1lbnQgZW52aXJvbm1lbnQnLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LUdyZWV0aW5nRW52aXJvbm1lbnRgXG4gICAgfSk7XG4gICAgLy8gT3V0cHV0IHRoZSBzZXJ2aWNlIG5hbWVcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnR3JlZXRpbmdTZXJ2aWNlTmFtZScsIHtcbiAgICAgIHZhbHVlOiBzZXJ2aWNlTmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnR3JlZXRpbmcgTGFtYmRhIHNlcnZpY2UgbmFtZSB1c2VkIGZvciB0ZWxlbWV0cnknLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LUdyZWV0aW5nU2VydmljZU5hbWVgXG4gICAgfSk7XG5cbiAgICBjb25zdCBIZWxsb0xhbWJkYUZ1bmN0aW9uID0gbmV3IGxhbWJkYS5GdW5jdGlvbih0aGlzLCAnSGVsbG9MYW1iZGFGdW5jdGlvbicsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi9zcmMvaW52b2tlci1sYW1iZGEnKSksXG4gICAgICBoYW5kbGVyOiAnaW5kZXguaGFuZGxlcicsXG4gICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuWDg2XzY0LFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRU5WSVJPTk1FTlQ6IGVudmlyb25tZW50LFxuICAgICAgICBHUkVFVElOR19BUElfRU5EUE9JTlQ6IGdyZWV0aW5nQXBpLmFwaUVuZHBvaW50LFxuICAgICAgfSxcbiAgICAgIGRlc2NyaXB0aW9uOiBgTGFtYmRhIGZ1bmN0aW9uIGZvciAke3NlcnZpY2VOYW1lfSBpbiAke2Vudmlyb25tZW50fSBlbnZpcm9ubWVudGAsXG4gICAgICB0cmFjaW5nOiBsYW1iZGEuVHJhY2luZy5BQ1RJVkUsXG4gICAgfSk7XG5cbiAgICAvLyBDcmVhdGUgSFRUUCBBUEkgR2F0ZXdheVxuICAgIGNvbnN0IGxhbWJkYUludGVncmF0aW9uID0gbmV3IGFwaWdhdGV3YXl2Ml9pbnRlZ3JhdGlvbnMuSHR0cExhbWJkYUludGVncmF0aW9uKFxuICAgICAgJ090ZWxBZG90SW50ZWdyYXRpb24nLCBcbiAgICAgIEhlbGxvTGFtYmRhRnVuY3Rpb25cbiAgICApO1xuXG4gICAgY29uc3QgaHR0cEFwaSA9IG5ldyBhcGlnYXRld2F5djIuSHR0cEFwaSh0aGlzLCAnT3RlbEFkb3RIdHRwQXBpJywge1xuICAgICAgYXBpTmFtZTogYCR7c2VydmljZU5hbWV9LUFQSS0ke2Vudmlyb25tZW50fWAsXG4gICAgICBkZXNjcmlwdGlvbjogYEhUVFAgQVBJIEdhdGV3YXkgZm9yICR7c2VydmljZU5hbWV9IGluICR7ZW52aXJvbm1lbnR9IGVudmlyb25tZW50YCxcbiAgICAgIGRlZmF1bHRJbnRlZ3JhdGlvbjogbGFtYmRhSW50ZWdyYXRpb24sXG4gICAgfSk7XG5cbiAgICAvLyBBZGQgcm9vdCBwYXRoXG4gICAgaHR0cEFwaS5hZGRSb3V0ZXMoe1xuICAgICAgcGF0aDogJy8nLFxuICAgICAgbWV0aG9kczogW2FwaWdhdGV3YXl2Mi5IdHRwTWV0aG9kLkdFVF0sXG4gICAgICBpbnRlZ3JhdGlvbjogbGFtYmRhSW50ZWdyYXRpb25cbiAgICB9KTtcbiAgICBcbiAgICAvLyBPdXRwdXQgdGhlIEFQSSBVUkxcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnQXBpVXJsJywge1xuICAgICAgdmFsdWU6IGh0dHBBcGkuYXBpRW5kcG9pbnQsXG4gICAgICBkZXNjcmlwdGlvbjogJ0hUVFAgQVBJIEdhdGV3YXkgZW5kcG9pbnQgVVJMJyxcbiAgICAgIGV4cG9ydE5hbWU6IGAke2lkfS1BcGlFbmRwb2ludGBcbiAgICB9KTtcblxuICAgIC8vIE91dHB1dCB0aGUgZW52aXJvbm1lbnRcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnRW52aXJvbm1lbnQnLCB7XG4gICAgICB2YWx1ZTogZW52aXJvbm1lbnQsXG4gICAgICBkZXNjcmlwdGlvbjogJ0RlcGxveW1lbnQgZW52aXJvbm1lbnQnLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LUVudmlyb25tZW50YFxuICAgIH0pO1xuXG4gICAgLy8gT3V0cHV0IHRoZSBzZXJ2aWNlIG5hbWVcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnU2VydmljZU5hbWUnLCB7XG4gICAgICB2YWx1ZTogc2VydmljZU5hbWUsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NlcnZpY2UgbmFtZSB1c2VkIGZvciB0ZWxlbWV0cnknLFxuICAgICAgZXhwb3J0TmFtZTogYCR7aWR9LVNlcnZpY2VOYW1lYFxuICAgIH0pO1xuXG4gICAgXG4gICAgLy8gQWRkIHRhZ3MgdG8gdGhlIExhbWJkYSBmdW5jdGlvblxuICAgIGNkay5UYWdzLm9mKEhlbGxvTGFtYmRhRnVuY3Rpb24pLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG4gICAgY2RrLlRhZ3Mub2YoSGVsbG9MYW1iZGFGdW5jdGlvbikuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ01hbmFnZWRCeScsICdDREsnKTtcbiAgICBjZGsuVGFncy5vZihIZWxsb0xhbWJkYUZ1bmN0aW9uKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBBUEkgR2F0ZXdheVxuICAgIGNkay5UYWdzLm9mKGh0dHBBcGkpLmFkZCgnRW52aXJvbm1lbnQnLCBlbnZpcm9ubWVudCk7XG4gICAgY2RrLlRhZ3Mub2YoaHR0cEFwaSkuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ01hbmFnZWRCeScsICdDREsnKTtcbiAgICBjZGsuVGFncy5vZihodHRwQXBpKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBncmVldGluZyBMYW1iZGEgZnVuY3Rpb25cbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdFbnZpcm9ubWVudCcsIGVudmlyb25tZW50KTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdTZXJ2aWNlTmFtZScsIHNlcnZpY2VOYW1lKTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0xhbWJkYSkuYWRkKCdQcm9qZWN0JywgJ090ZWxBZG90TGFtYmRhJyk7XG4gICAgY2RrLlRhZ3Mub2YoZ3JlZXRpbmdMYW1iZGEpLmFkZCgnTWFuYWdlZEJ5JywgJ0NESycpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nTGFtYmRhKS5hZGQoJ1dvcmtzaG9wJywgJ0FXUyBDREsgQURPVCBXb3Jrc2hvcCcpO1xuICAgIC8vIEFkZCB0YWdzIHRvIHRoZSBncmVldGluZyBBUEkgR2F0ZXdheVxuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ0Vudmlyb25tZW50JywgZW52aXJvbm1lbnQpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ1NlcnZpY2VOYW1lJywgc2VydmljZU5hbWUpO1xuICAgIGNkay5UYWdzLm9mKGdyZWV0aW5nQXBpKS5hZGQoJ1Byb2plY3QnLCAnT3RlbEFkb3RMYW1iZGEnKTtcbiAgICBjZGsuVGFncy5vZihncmVldGluZ0FwaSkuYWRkKCdNYW5hZ2VkQnknLCAnQ0RLJyk7XG4gICAgY2RrLlRhZ3Mub2YoZ3JlZXRpbmdBcGkpLmFkZCgnV29ya3Nob3AnLCAnQVdTIENESyBBRE9UIFdvcmtzaG9wJyk7XG4gICAgLy8gQWRkIHRhZ3MgdG8gdGhlIHN0YWNrXG4gICAgY2RrLlRhZ3Mub2YodGhpcykuYWRkKCdFbnZpcm9ubWVudCcsIGVudmlyb25tZW50KTtcbiAgICBjZGsuVGFncy5vZih0aGlzKS5hZGQoJ1NlcnZpY2VOYW1lJywgc2VydmljZU5hbWUpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnUHJvamVjdCcsICdPdGVsQWRvdExhbWJkYScpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnTWFuYWdlZEJ5JywgJ0NESycpO1xuICAgIGNkay5UYWdzLm9mKHRoaXMpLmFkZCgnV29ya3Nob3AnLCAnQVdTIENESyBBRE9UIFdvcmtzaG9wJyk7XG5cbiAgfVxufSJdfQ==